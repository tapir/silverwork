---
# yaml-language-server: $schema=https://schema.blue-build.org/module-list-v1.json
modules:
  - type: dnf
    repos:
      files:
        - https://negativo17.org/repos/fedora-nvidia.repo

  - type: script
    snippets:
      - |
        cp /usr/sbin/akmodsbuild /usr/sbin/akmodsbuild.backup
        sed -i '/if \[\[ -w \/var \]\] ; then/,/fi/d' /usr/sbin/akmodsbuild
        dnf install -y --setopt=install_weak_deps=False --setopt=tsflags=noscripts akmod-nvidia nvidia-kmod-common nvidia-modprobe
        akmods --force --verbose --kernels "$(rpm -q "kernel-cachyos-lto" --queryformat '%{VERSION}-%{RELEASE}.%{ARCH}')" --kmod "nvidia"
        mv /usr/sbin/akmodsbuild.backup /usr/sbin/akmodsbuild

  - type: dnf
    repos:
      files:
        - https://nvidia.github.io/libnvidia-container/stable/rpm/nvidia-container-toolkit.repo
    install:
      skip-unavailable: true
      packages:
        - libva-nvidia-driver
        - nvidia-driver
        - nvidia-persistenced
        - nvidia-settings
        - nvidia-driver-cuda
        - libnvidia-cfg
        - libnvidia-fbc
        - libnvidia-ml
        - libnvidia-gpucomp
        - nvidia-driver-libs.i686
        - nvidia-driver-cuda-libs.i686
        - libnvidia-fbc.i686
        - libnvidia-ml.i686
        - libnvidia-gpucomp.i686
        - nvidia-container-toolkit
    remove:
        packages:
          - akmod-nvidia
          - akmods
    repos:
      files:
        remove:
          - fedora-nvidia.repo
          - nvidia-container-toolkit.repo

  - type: script
    snippets:
      - |
        semodule -i /usr/share/silvercachy/nvidia-container.pp
        rm -f /usr/share/silvercachy/nvidia-container.pp
      
  - type: kargs
    kargs:
      - rd.driver.blacklist=nouveau
      - modprobe.blacklist=nouveau
      - nvidia-drm.modeset=1
      - nvidia-drm.fbdev=1